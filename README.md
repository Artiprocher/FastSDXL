# FastSDXL

This is an efficient implementation of Stable-Diffusion-XL. I make the following improvements:

* Reconstruct the architecture of UNet. This UNet implementation is faster than others ([Diffusers](https://github.com/huggingface/diffusers), [Fooocus](https://github.com/lllyasviel/Fooocus), etc.). If you are interested in this implementation, please see `FastSDXL/BlockUNet.py`. The source code of this UNet is short and easy to understand. You can also use this component in your own projects.
* Use a trainable scheduler named [OLSS](https://arxiv.org/abs/2305.14677). The implementation of OLSS is based on [this project](https://github.com/alibaba/EasyNLP/tree/master/diffusion/olss_scheduler). I find this scheduler can improve the quality of generated images with given steps but we need to train it first (the training process requires a few minutes). To synthesize images with a specific style, OLSS is a good choice.

## Usage

The code is headless. I developed this project based on `diffusers==0.21.3`. If you find it cannot run with another version of `diffusers`, please open an issue and tell me.

```
pip install diffusers safetensors torch gradio
```

To launch a webui without OLSS scheduler, please run the following command.

```
python launch_without_olss.py
```

To train an OLSS scheduler, please see `run_olss.py` for more details.

I trained an OLSS scheduler with the style of "Slightly Cinematic". You can use it by running the following command.

```
python launch_with_olss.py
```

## Efficiency of the reconstructed UNet

I tested my code using NVidia 3060 laptop (6G, 85W). The resolution is 1024*1024, and the model is converted to float16 format.

* Diffusers: CUDA out of memory
* Fooocus: 1.78s/it
* FastSDXL (ours): 1.17s/it

## Performance of OLSS scheduler

Here are some examples of OLSS.

Prompt template: cinematic still {prompt}. emotional, harmonious, vignette, highly detailed, high budget, bokeh, cinemascope, moody, epic, gorgeous, film grain, grainy
Negative prompt: anime, cartoon, graphic, text, painting, crayon, graphite, abstract, glitch, deformed, mutated, ugly, disfigured

* a young girl, black hair, white clothes, in a garden, the background is red and white flowers

In the image generated by OLSS, the details of flowers on the right are more realistic.

|DDIM|DPM|OLSS|
|-|-|-|
|![ddim](https://github.com/Artiprocher/FastSDXL/assets/35051019/942ccd69-1e7a-43ea-80f7-747a756d1cfb)|![dpmsolver](https://github.com/Artiprocher/FastSDXL/assets/35051019/a33302d8-2744-4e13-8bbd-66d13fcb832f)|![olss](https://github.com/Artiprocher/FastSDXL/assets/35051019/06446a51-8e41-4e3e-b37d-21ed9370d998)|

* a forest in spring, birds

More birds.

|DDIM|DPM|OLSS|
|-|-|-|
|![ddim](https://github.com/Artiprocher/FastSDXL/assets/35051019/4a13362f-1d82-4400-8d96-cafd2eff4907)|![dpmsolver](https://github.com/Artiprocher/FastSDXL/assets/35051019/9174b534-46bf-41da-b914-0f3259bfe1b3)|![olss](https://github.com/Artiprocher/FastSDXL/assets/35051019/223667d6-c3d4-4b0c-987f-b687754876e3)|

* an orange cat and a pink ball on a white sofa

In this example, the image generated by OLSS is completely different with others.

|DDIM|DPM|OLSS|
|-|-|-|
|![ddim](https://github.com/Artiprocher/FastSDXL/assets/35051019/97d26ea9-cde2-4ed6-a0e9-b08e012cad07)|![dpmsolver](https://github.com/Artiprocher/FastSDXL/assets/35051019/655a4d59-12a0-4a1e-a5bd-fc773f1c64ae)|![olss](https://github.com/Artiprocher/FastSDXL/assets/35051019/a201bf44-a343-40bc-a4ed-58226d34af64)|

* a robot, with blue lightsaber, in a city

Sometimes OLSS can modify the composition and fix the composition error.

|DDIM|DPM|OLSS|
|-|-|-|
|![ddim](https://github.com/Artiprocher/FastSDXL/assets/35051019/deae9978-f2c2-40e2-bb3b-7cbc118d8780)|![dpmsolver](https://github.com/Artiprocher/FastSDXL/assets/35051019/c68e9dd1-bba5-49c1-8592-c66016d89cff)|![olss](https://github.com/Artiprocher/FastSDXL/assets/35051019/e9a0337a-9b69-447f-80ab-5021fdff63ad)|
